---
title: "MongoDB Essentials"
date: 2024-12-12
draft: false
category: "database"
tags: ["database-knowhow", "mongodb", "nosql", "document-db"]
---


MongoDB queries, aggregation, and Docker setup for document-based NoSQL database.

---

## Docker Setup

### Docker Run

```bash
# Run MongoDB
docker run -d \
  --name mongodb \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=password \
  -v mongo-data:/data/db \
  -p 27017:27017 \
  mongo:7

# Connect
docker exec -it mongodb mongosh -u admin -p password
```

### Docker Compose

```yaml
version: '3.8'

services:
  mongodb:
    image: mongo:7
    container_name: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password
      MONGO_INITDB_DATABASE: mydb
    volumes:
      - mongo-data:/data/db
      - ./init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js
    ports:
      - "27017:27017"
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_URL: mongodb://admin:password@mongodb:27017/
    ports:
      - "8081:8081"
    depends_on:
      - mongodb
    restart: unless-stopped

volumes:
  mongo-data:
```

---

## Basic Commands

```javascript
// Show databases
show dbs

// Use/create database
use mydb

// Show collections
show collections

// Create collection
db.createCollection('users')

// Drop collection
db.users.drop()

// Drop database
db.dropDatabase()
```

---

## CRUD Operations

### Insert

```javascript
// Insert one
db.users.insertOne({
    username: 'john_doe',
    email: 'john@example.com',
    age: 30,
    tags: ['developer', 'nodejs'],
    address: {
        city: 'New York',
        country: 'USA'
    },
    createdAt: new Date()
})

// Insert many
db.users.insertMany([
    { username: 'alice', email: 'alice@example.com', age: 25 },
    { username: 'bob', email: 'bob@example.com', age: 35 }
])
```

### Find

```javascript
// Find all
db.users.find()

// Find with filter
db.users.find({ age: { $gt: 25 } })

// Find one
db.users.findOne({ username: 'john_doe' })

// Projection (select fields)
db.users.find({}, { username: 1, email: 1, _id: 0 })

// Sort
db.users.find().sort({ age: -1 })

// Limit and skip
db.users.find().limit(10).skip(20)

// Count
db.users.countDocuments({ age: { $gt: 25 } })

// Distinct
db.users.distinct('age')
```

### Update

```javascript
// Update one
db.users.updateOne(
    { username: 'john_doe' },
    { $set: { email: 'newemail@example.com' } }
)

// Update many
db.users.updateMany(
    { age: { $lt: 30 } },
    { $set: { category: 'young' } }
)

// Replace one
db.users.replaceOne(
    { username: 'john_doe' },
    { username: 'john_doe', email: 'john@example.com', age: 31 }
)

// Upsert (insert if not exists)
db.users.updateOne(
    { username: 'jane' },
    { $set: { email: 'jane@example.com' } },
    { upsert: true }
)

// Update operators
db.users.updateOne(
    { username: 'john' },
    {
        $set: { email: 'new@example.com' },
        $inc: { age: 1 },
        $push: { tags: 'mongodb' },
        $currentDate: { lastModified: true }
    }
)
```

### Delete

```javascript
// Delete one
db.users.deleteOne({ username: 'john_doe' })

// Delete many
db.users.deleteMany({ age: { $lt: 18 } })

// Delete all
db.users.deleteMany({})
```

---

## Query Operators

```javascript
// Comparison
db.users.find({ age: { $eq: 30 } })  // Equal
db.users.find({ age: { $ne: 30 } })  // Not equal
db.users.find({ age: { $gt: 30 } })  // Greater than
db.users.find({ age: { $gte: 30 } }) // Greater than or equal
db.users.find({ age: { $lt: 30 } })  // Less than
db.users.find({ age: { $lte: 30 } }) // Less than or equal
db.users.find({ age: { $in: [25, 30, 35] } })
db.users.find({ age: { $nin: [25, 30] } })

// Logical
db.users.find({ $and: [{ age: { $gt: 25 } }, { age: { $lt: 35 } }] })
db.users.find({ $or: [{ age: { $lt: 25 } }, { age: { $gt: 35 } }] })
db.users.find({ age: { $not: { $lt: 30 } } })

// Element
db.users.find({ email: { $exists: true } })
db.users.find({ age: { $type: 'number' } })

// Array
db.users.find({ tags: 'developer' })
db.users.find({ tags: { $all: ['developer', 'nodejs'] } })
db.users.find({ tags: { $size: 2 } })

// Regex
db.users.find({ username: /^john/ })
db.users.find({ email: { $regex: '@gmail.com$' } })
```

---

## Aggregation Pipeline

```javascript
// Basic aggregation
db.orders.aggregate([
    { $match: { status: 'completed' } },
    { $group: {
        _id: '$userId',
        totalSpent: { $sum: '$total' },
        orderCount: { $sum: 1 }
    }},
    { $sort: { totalSpent: -1 } },
    { $limit: 10 }
])

// Join (lookup)
db.orders.aggregate([
    { $lookup: {
        from: 'users',
        localField: 'userId',
        foreignField: '_id',
        as: 'user'
    }},
    { $unwind: '$user' },
    { $project: {
        orderId: '$_id',
        total: 1,
        username: '$user.username',
        email: '$user.email'
    }}
])

// Group by date
db.orders.aggregate([
    { $group: {
        _id: {
            year: { $year: '$createdAt' },
            month: { $month: '$createdAt' }
        },
        total: { $sum: '$total' },
        count: { $sum: 1 }
    }},
    { $sort: { '_id.year': -1, '_id.month': -1 } }
])

// Complex aggregation
db.products.aggregate([
    { $match: { price: { $gt: 50 } } },
    { $group: {
        _id: '$category',
        avgPrice: { $avg: '$price' },
        minPrice: { $min: '$price' },
        maxPrice: { $max: '$price' },
        count: { $sum: 1 }
    }},
    { $project: {
        category: '$_id',
        avgPrice: { $round: ['$avgPrice', 2] },
        minPrice: 1,
        maxPrice: 1,
        count: 1,
        _id: 0
    }},
    { $sort: { avgPrice: -1 } }
])
```

---

## Indexes

```javascript
// Create index
db.users.createIndex({ email: 1 })

// Compound index
db.users.createIndex({ username: 1, email: 1 })

// Unique index
db.users.createIndex({ email: 1 }, { unique: true })

// Text index (full-text search)
db.articles.createIndex({ title: 'text', content: 'text' })

// Search with text index
db.articles.find({ $text: { $search: 'mongodb database' } })

// TTL index (auto-delete after time)
db.sessions.createIndex({ createdAt: 1 }, { expireAfterSeconds: 3600 })

// List indexes
db.users.getIndexes()

// Drop index
db.users.dropIndex('email_1')

// Explain query
db.users.find({ email: 'test@example.com' }).explain('executionStats')
```

---

## Python Integration

```python
from pymongo import MongoClient
from datetime import datetime

# Connect
client = MongoClient('mongodb://admin:password@localhost:27017/')
db = client['mydb']
users = db['users']

# Insert
user_id = users.insert_one({
    'username': 'john_doe',
    'email': 'john@example.com',
    'age': 30,
    'createdAt': datetime.now()
}).inserted_id

# Find
user = users.find_one({'username': 'john_doe'})
print(user)

# Find many
for user in users.find({'age': {'$gt': 25}}):
    print(user)

# Update
users.update_one(
    {'username': 'john_doe'},
    {'$set': {'email': 'newemail@example.com'}}
)

# Delete
users.delete_one({'username': 'john_doe'})

# Aggregation
pipeline = [
    {'$match': {'age': {'$gt': 25}}},
    {'$group': {
        '_id': None,
        'avgAge': {'$avg': '$age'},
        'count': {'$sum': 1}
    }}
]
result = list(users.aggregate(pipeline))
print(result)
```

---